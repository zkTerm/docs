---
title: zkCompression
description: 'Light Protocol integration for Solana ZK Compression'
---

## Overview

zkCompression integrates Light Protocol to enable ZK Compression on Solana, allowing you to compress SPL tokens and reduce storage costs by up to 1000x.

<Info>
  Compressed tokens maintain full functionality while using significantly less on-chain storage through zero-knowledge state compression.
</Info>

## How It Works

<Frame>
  <img src="/images/zk-compression.png" alt="ZK Compression Flow" />
</Frame>

<Steps>
  <Step title="Compress">
    Regular SPL tokens are converted to compressed tokens stored in a Merkle tree state.
  </Step>
  <Step title="Store">
    Only the Merkle root is stored on-chain, dramatically reducing costs.
  </Step>
  <Step title="Decompress">
    Compressed tokens can be decompressed back to regular SPL tokens at any time.
  </Step>
</Steps>

## Cost Comparison

| Operation | Regular SPL | Compressed |
|-----------|-------------|------------|
| Token Account | ~0.002 SOL | ~0.00002 SOL |
| Transfer | ~0.000005 SOL | ~0.000001 SOL |
| Storage per token | ~165 bytes | ~0.165 bytes |

<Note>
  Compressed tokens are 1000x cheaper to store while maintaining the same functionality.
</Note>

## Terminal Commands

### Compress Tokens

```bash
compress <mint_address> <amount>
```

Compress regular SPL tokens to ZK compressed tokens.

**Example:**
```bash
compress EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v 100
```

### Decompress Tokens

```bash
decompress <mint_address> <amount>
```

Decompress tokens back to regular SPL tokens.

**Example:**
```bash
decompress EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v 50
```

### View Token Balances

```bash
zk tokens
```

Display unified portfolio view of all tokens (regular + compressed):

```
Token Portfolio
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Token           Balance      Type         Mint
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
USDC            1,234.56     Regular      EPjFWdd5...
USDC            500.00       [C]          EPjFWdd5...
SOL             10.5         Regular      So11111...
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
[C] = Compressed Token
```

## API Reference

### Compress Tokens

<ParamField body="mint" type="string" required>
  SPL token mint address
</ParamField>

<ParamField body="amount" type="number" required>
  Amount to compress (in token units)
</ParamField>

```bash
POST /api/compress
Content-Type: application/json

{
  "mint": "EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v",
  "amount": 100
}
```

**Response:**

```json
{
  "success": true,
  "txSignature": "5abc...",
  "compressed": {
    "amount": "100000000",
    "mint": "EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v"
  }
}
```

### Decompress Tokens

```bash
POST /api/decompress
Content-Type: application/json

{
  "mint": "EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v",
  "amount": 50
}
```

**Response:**

```json
{
  "success": true,
  "txSignature": "6def...",
  "decompressed": {
    "amount": "50000000",
    "mint": "EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v"
  }
}
```

## Technical Details

### Light Protocol Integration

zkCompression uses the following Light Protocol packages:

```typescript
import { Rpc, createRpc } from "@lightprotocol/stateless.js";
import { compress, decompress } from "@lightprotocol/compressed-token";
```

### Wallet Security

<Warning>
  zkCompression implements wallet mutex locking and private key zeroization for security.
</Warning>

**Security Features:**
- Mutex locking prevents concurrent wallet access
- Private keys are zeroized from memory after use
- Automatic retry polling for RPC indexer sync
- Auto-create Associated Token Account during decompression

### RPC Configuration

zkCompression uses Helius RPC with Light Protocol extensions:

```typescript
const connection = createRpc(
  process.env.HELIUS_RPC_URL,
  process.env.HELIUS_RPC_URL,  // Compression RPC
  process.env.HELIUS_RPC_URL   // Prover RPC
);
```

## Error Handling

Common errors and solutions:

| Error | Cause | Solution |
|-------|-------|----------|
| `Account not found` | ATA doesn't exist | Auto-created during decompression |
| `Insufficient balance` | Not enough tokens | Check balance with `zk tokens` |
| `RPC indexer sync` | Indexer lag | Automatic retry polling handles this |

## Example: Full Compression Flow

```bash
# 1. Check current balances
> zk tokens
USDC: 1000.00 (Regular)

# 2. Compress 500 USDC
> compress EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v 500
Compressing 500 USDC...
Transaction: 5abc...
Compression complete!

# 3. Check updated balances
> zk tokens
USDC: 500.00 (Regular)
USDC: 500.00 [C]

# 4. Decompress 250 USDC
> decompress EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v 250
Decompressing 250 USDC...
Transaction: 6def...
Decompression complete!

# 5. Final balances
> zk tokens
USDC: 750.00 (Regular)
USDC: 250.00 [C]
```

## Use Cases

<CardGroup cols={2}>
  <Card title="Airdrops" icon="parachute-box">
    Airdrop tokens to millions of wallets at 1/1000th the cost
  </Card>
  <Card title="Gaming" icon="gamepad">
    Store in-game assets efficiently on-chain
  </Card>
  <Card title="NFT Collections" icon="images">
    Compress large NFT collections for affordable minting
  </Card>
  <Card title="DeFi Protocols" icon="coins">
    Reduce protocol storage costs significantly
  </Card>
</CardGroup>
